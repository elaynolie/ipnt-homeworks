# Домашнее задание к занятию "Основы работы с Asterisk"

### Цель задания

В результате выполнения задания вы научитесь:  

1. Установливать Asterisk на виртуальной машине.
2. Настраивать учетные записи для регистрации на данном сервере.
3. Настраивать простейшую маршрутизацию вызова между внутренними абонентами данной АТС.

------

### Инструкция к выполнению домашнего задания

1. Сделайте копию [Шаблона для домашнего задания](https://docs.google.com/document/d/1youKpKm_JrC0UzDyUslIZW2E2bIv5OVlm_TQDvH5Pvs/edit) себе на Google Disk.
2. В названии файла введите корректное название лекции и вашу фамилию и имя.
3. Зайдите в “Настройки доступа” и выберите доступ “Просматривать могут все в Интернете, у кого есть ссылка”.  Ссылка на инструкцию [Как предоставить доступ к файлам и папкам на Google Диске](https://support.google.com/docs/answer/2494822?hl=ru&co=GENIE.Platform%3DDesktop)
4. Скопируйте текст задания в свой документ.
5. Выполните домашнее задание, запишите ответы и приложите необходимые скриншоты в свой Google Doc.
6. Для проверки домашнего задания преподавателем отправьте ссылку на ваш документ в личном кабинете.
7. Любые вопросы по решению задач задавайте в чате учебной группы.

------

 ### Подготовка к выполнению задания
 
 1. Скачайте текущую сертифицированную версию Asterisk [по ссылке](https://downloads.asterisk.org/pub/telephony/asterisk/asterisk-16.30.1-patch.tar.gz)
 2. В каталоге, куда были загружены исходники, найдите и выполните скрипт по установке необходимых для Asterisk пакетов - его можно найти в каталоге /contrib/scripts/install_prereq install
 3. В каталоге, куда были загружены исходники, выполните `./configure`
 4. Выполните `make menuselect`
 5. Выберите модули cdr_odbc, cdr_adaptive_odbc, chan_sip и нажмите "Save & Exit".
 6. Выполните 'make && make install && make samples && make config && make install-logrotate'
 7. Выполните `/usr/sbin/asterisk`
 8. Подключитесь к Asterisk удаленно путём ввода команды Asterisk -rvvvv
 9. Установите [zoiper](https://www.zoiper.com/en/voip-softphone/download/current) на телефон и пк для звонков.
10. Сетевой адаптер вашей виртуальной машины должен работать в режиме "сетевой мост".   

 **Примечение:**
Для этапа "Подготовка к выполнению задания" можете воспользоваться [подробной инструкцией](https://github.com/netology-code/ipnt-homeworks/blob/main/Instruction.md) или загрузить [виртуальную машину с настроенным Asterisk для выполнения задания](https://github.com/netology-code/ipnt-homeworks/releases/tag/Asterisk-v1).   
В случае использования ВМ c  настроенным Asterisk пропустите этап "Подготовка к выполнению задания".
 
------
 
### Задание 1. Настройка учетных записей

1. Назначьте права для рабочей папки Asterisk `chmod 777 /var/run/asterisk/`.
2. Перезагрузите сервис `systemctl restart asterisk`.
3. Очистите стандартные конфигурационные файлы (sip.conf && extensions.conf). В файле sip.conf (`nano /etc/asterisk/sip.conf`) необходимо настроить блок [general] согласно параметрам вашей виртуальной машины (подробно было разобрано на лекции 10.4) и две учетные записи [1001], [1002]

   [XXXX]  
  type=friend   
  secret=XXXXXXX    - *в secret должен быть указан пароль*  
  context=XXXXXX    - *в качестве context - название контекста диалплана, в котором будут обрабатывать звонки*  
  host=dynamic  
  disallow=all  
  allow=ulaw,alaw  
  nat=no  
  directmedia=no  
  qualify=yes 

   В [general] нужно определелить context по умолчанию - назовем его "from-internal"

4. После добавления данных учетных записей в файл sip.conf выполните следующую команду:  
`/usr/sbin/asterisk -rx 'sip reload'` 

Если команда возвращается с ошибкой, зайдите в `/usr/sbin/asterisk -rvvv`.   
Дайте команду для запуска sip модуля в ручную
`module load chan_sip.so`.

5. Зарегистрируйте данные учетные записи на софтфоне (программа zoiper).

*Для проверки задания выполните команду `/usr/sbin/asterisk -rx 'sip show peers' | grep`  и приложите скриншот ответа команды и файл sip.conf*

------

### Задание 2. Настройка плана набора

1. В файле extensions.conf (`nano /etc/asterisk/extensions.conf`) настройте обработку вызовов в контексте по умолчанию "from-internal"

    [from-internal]  
    exten => _X.,1,Dial(SIP/${EXTEN})  
    same => n,Hangup  

2. Выполните перезагрузку сервисов Asterisk, чтобы  точно все настройки применились:  
`systemctl restart asterisk`

Если вручную запускали SIP, примените следующую команду:   
`/usr/sbin/asterisk -rx 'module load chan_sip.so'`

3. Осуществите вызов через zoiper, убедитесь, что прошел звонок.  
   Во время вызова выполните команду: 
`/usr/sbin/asterisk -rx 'core show channels verbose'`.

**Примечаниe**   
Для подключения Zoiper к серверу нужно использовать учетную запись вида: xxxx@y.y.y.y:zzzz



*Для проверки задания приложите скриншот ответа команды из п.2 и файл extensions.conf*

------

### Правила приема домашнего задания

В личном кабинете отправлены:

- ссылка на документ (Google Doc) с выполненным заданием и конфигурационные файлы Asterisk (стандартные конфиги полученные make samples не принимаются - необходимо конфигурацию полностью самому). В документе настроены права доступа “Просматривать могут все в Интернете, у кого есть ссылка”;
- файлы в формате .conf, png или .jpg.


### Критерии оценки

Зачет - выполнены все задания, ответы даны в развернутой форме, приложены соответствующие скриншоты и файлы проекта, в выполненных заданиях нет противоречий и нарушения логики.

На доработку - задание выполнено частично или не выполнено, в логике выполнения заданий есть противоречия, существенные недостатки.
